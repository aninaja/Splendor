{% extends 'base.html' %} {% block title %} Dashboard {% endblock title %}

{% block page_title %} Dashboard {% endblock page_title %} {% block content %}

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <!-- Small boxes (Stat box) -->
        <div class="row">
            <div class="col-12">
                <div class="card card-outline card-info">
                    <div class="card-header">
                        <h3 class="card-title">Most Chosen Treatment by Appointment</h3>
                        <button class="btn btn-outline-info btn-sm" id="btn-download" style="float:right">
                            <i class="fas fa-arrow-circle-down"></i> Download</button>
                    </div>
                    <div class="card-body">
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <label class="input-group-text" for="inputGroupSelect01">Options</label>
                            </div>
                            <select class="custom-select" id="inputGroupSelect01">
                                <option selected>Choose...</option>
                                <option value="1">Weekly</option>
                                <option value="2">Monthly</option>
                                <option value="3">Yearly</option>
                            </select>
                        </div>
                        {% if result %}
                            <p>The most availed treatment is {{ result.treatment__name }} with {{ result.count }} appointments.</p>
                        {% else %}
                            <p>No appointments found for the specified time period.</p>
                        {% endif %}
                        <canvas id="chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- /.container-fluid -->
</section>
<!-- /.content -->

{% endblock content %}

{% block script %}
<script>
    setInterval(function () {
        window.location.reload();
    }, 60000); // refresh every 1 min
</script>

<script>
   const myChart = new Chart(document.getElementById('chart').getContext("2d"),
    {
        type: 'doughnut',
        data: {
            labels: {{treatment_label|safe}},
            datasets: [{
                data: {{treatment_data|safe}},
                backgroundColor: ["#EE0733", "#073EA8", "#6CCE32", "#FD3E81", "#FFC92E", "#FF761C", "#D51EFF"],
                label: "Count",
                borderWidth: 1
            }]
        },
    options: {
        animation: {
            duration: 1500,
        }
    },
 });

var image = myChart.toBase64Image();
console.log(image);

document.getElementById('btn-download').onclick = function() {
  // Trigger the download
  var a = document.createElement('a');
  a.href = myChart.toBase64Image();
  var now = new Date();
  var reports = 'reports_' + now.getFullYear() + (now.getMonth() + 1) + now.getDate() + '_' + now.getHours() + now.getMinutes() + now.getSeconds() + '.png';
  a.download = reports;
  a.click();
}
</script>
{% endblock script %}
